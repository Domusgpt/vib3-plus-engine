<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VIB3+ Engine - 24 Geometries ‚Ä¢ 6D Rotation</title>
    
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&display=swap" rel="stylesheet" onerror="console.warn('Google Fonts failed to load - using fallback')">
    
    <!-- Organized CSS Architecture -->
    <link rel="stylesheet" href="styles/base.css">
    <link rel="stylesheet" href="styles/header-enhanced.css">
    <link rel="stylesheet" href="styles/controls.css">
    <link rel="stylesheet" href="styles/reactivity.css">
    <link rel="stylesheet" href="styles/gallery-modal.css">
    <link rel="stylesheet" href="styles/bottom-bezel.css">
    <link rel="stylesheet" href="styles/geometry-tabs.css">
    <link rel="stylesheet" href="styles/mobile.css">
    <link rel="stylesheet" href="styles/animations.css">
</head>
<body class="loading">
    <!-- Enhanced Top Navigation Bar -->
    <div class="top-bar">
        <!-- Logo Section -->
        <div class="logo-section">
            <div class="logo">VIB3+ ENGINE</div>
            <div class="engine-status">24 GEOMETRIES ‚Ä¢ 6D</div>
        </div>

        <!-- System Selector -->
        <div class="system-selector">
            <button class="system-btn active" data-system="faceted" onclick="switchSystem('faceted')">
                <span class="system-icon">üî∑</span>
                <span>FACETED</span>
            </button>
            <button class="system-btn" data-system="quantum" onclick="switchSystem('quantum')">
                <span class="system-icon">üåå</span>
                <span>QUANTUM</span>
            </button>
            <button class="system-btn" data-system="holographic" onclick="switchSystem('holographic')">
                <span class="system-icon">‚ú®</span>
                <span>HOLOGRAPHIC</span>
            </button>
            <button class="system-btn" data-system="polychora" onclick="switchSystem('polychora')">
                <span class="system-icon">üîÆ</span>
                <span>POLYCHORA</span>
            </button>
        </div>

        <!-- Action Section -->
        <div class="action-section">
            <!-- Save Button (prominent) -->
            <button class="save-btn" onclick="saveToGallery()" title="Save Current State">
                üíæ <span>SAVE</span>
            </button>

            <!-- Other Action Buttons -->
            <div class="action-buttons">
                <button class="action-btn" onclick="openGallery()" title="Gallery">üñºÔ∏è</button>
                <button class="action-btn" onclick="toggleAudio()" title="Audio">üéµ</button>
                <button class="action-btn" onclick="toggleDeviceTilt()" title="Device Tilt (4D Rotation)" id="tiltBtn">üì±</button>
                <button class="action-btn" onclick="showLLMInterface()" title="AI Parameters">ü§ñ</button>
                <button class="action-btn" onclick="toggleInteractivity()" title="Interactivity Menu (Press I)">I</button>
            </div>
        </div>
    </div>

    <!-- Main Canvas Container -->
    <div class="canvas-container" id="canvasContainer">
        <!-- Dynamic Canvas Containers - Canvases created/destroyed per system -->
        <div class="holographic-layers" id="vib34dLayers" style="display: block;"></div>
        <div class="holographic-layers" id="quantumLayers" style="display: none;"></div>
        <div class="holographic-layers" id="holographicLayers" style="display: none;"></div>
        <div class="holographic-layers" id="polychoraLayers" style="display: none;"></div>
    </div>

    <!-- Bottom Bezel Control Panel (Tab-Based) -->
    <div class="control-panel" id="controlPanel">
        <!-- Bezel Header with Tabs -->
        <div class="bezel-header">
            <div class="bezel-tabs">
                <button class="bezel-tab active" data-tab="controls" onclick="switchBezelTab('controls')">
                    <span class="tab-icon">‚öôÔ∏è</span>
                    <span>Controls</span>
                </button>
                <button class="bezel-tab" data-tab="color" onclick="switchBezelTab('color')">
                    <span class="tab-icon">üé®</span>
                    <span>Color</span>
                </button>
                <button class="bezel-tab" data-tab="geometry" onclick="switchBezelTab('geometry')">
                    <span class="tab-icon">üß¨</span>
                    <span>Geometry</span>
                </button>
                <button class="bezel-tab" data-tab="reactivity" onclick="switchBezelTab('reactivity')">
                    <span class="tab-icon">üéõÔ∏è</span>
                    <span>Reactivity</span>
                </button>
                <button class="bezel-tab" data-tab="export" onclick="switchBezelTab('export')">
                    <span class="tab-icon">üíæ</span>
                    <span>Export</span>
                </button>
            </div>

            <!-- Quick Actions (shown when collapsed) -->
            <div class="quick-access">
                <button class="quick-action-btn" onclick="quickRandomize()" title="Quick Randomize">üé≤</button>
                <button class="quick-action-btn" onclick="quickSave()" title="Quick Save">üíæ</button>
                <button class="quick-action-btn" onclick="quickGallery()" title="Open Gallery">üñºÔ∏è</button>
            </div>

            <!-- Collapse Toggle -->
            <button class="bezel-collapse-btn" onclick="toggleBezelCollapse()" title="Toggle Controls (Ctrl+B / Space)">‚ñº</button>
        </div>

        <!-- Tab 1: Controls Content (6D Rotations + Visual Parameters) -->
        <div class="bezel-content active" id="controls-content">
            <div class="tab-content-grid">
                <!-- 3D Space Rotations -->
                <div class="control-section">
                    <div class="section-title">3D Space Rotations</div>
                    <div class="control-group">
                        <div class="control-label">
                            <span>X-Y Plane</span>
                            <span class="control-value" id="rot4dXY-display">0.00</span>
                        </div>
                        <input type="range" id="rot4dXY" class="control-slider" min="-6.28" max="6.28" step="0.01" value="0"
                               oninput="updateParameter('rot4dXY', this.value)">
                    </div>
                    <div class="control-group">
                        <div class="control-label">
                            <span>X-Z Plane</span>
                            <span class="control-value" id="rot4dXZ-display">0.00</span>
                        </div>
                        <input type="range" id="rot4dXZ" class="control-slider" min="-6.28" max="6.28" step="0.01" value="0"
                               oninput="updateParameter('rot4dXZ', this.value)">
                    </div>
                    <div class="control-group">
                        <div class="control-label">
                            <span>Y-Z Plane</span>
                            <span class="control-value" id="rot4dYZ-display">0.00</span>
                        </div>
                        <input type="range" id="rot4dYZ" class="control-slider" min="-6.28" max="6.28" step="0.01" value="0"
                               oninput="updateParameter('rot4dYZ', this.value)">
                    </div>
                </div>

                <!-- 4D Hyperspace Rotations -->
                <div class="control-section">
                    <div class="section-title">4D Hyperspace Rotations</div>
                    <div class="control-group">
                        <div class="control-label">
                            <span>X-W Plane</span>
                            <span class="control-value" id="rot4dXW-display">0.00</span>
                        </div>
                        <input type="range" id="rot4dXW" class="control-slider" min="-6.28" max="6.28" step="0.01" value="0"
                               oninput="updateParameter('rot4dXW', this.value)">
                    </div>
                    <div class="control-group">
                        <div class="control-label">
                            <span>Y-W Plane</span>
                            <span class="control-value" id="rot4dYW-display">0.00</span>
                        </div>
                        <input type="range" id="rot4dYW" class="control-slider" min="-6.28" max="6.28" step="0.01" value="0"
                               oninput="updateParameter('rot4dYW', this.value)">
                    </div>
                    <div class="control-group">
                        <div class="control-label">
                            <span>Z-W Plane</span>
                            <span class="control-value" id="rot4dZW-display">0.00</span>
                        </div>
                        <input type="range" id="rot4dZW" class="control-slider" min="-6.28" max="6.28" step="0.01" value="0"
                               oninput="updateParameter('rot4dZW', this.value)">
                    </div>
                </div>

                <!-- Visual Parameters -->
                <div class="control-section">
                    <div class="section-title">Visual Parameters</div>
                    <div class="control-group">
                        <div class="control-label">
                            <span>Grid Density</span>
                            <span class="control-value" id="gridDensity-display">15</span>
                        </div>
                        <input type="range" id="gridDensity" class="control-slider" min="5" max="100" step="1" value="15"
                               oninput="updateParameter('gridDensity', this.value)">
                    </div>
                    <div class="control-group">
                        <div class="control-label">
                            <span>Morph Factor</span>
                            <span class="control-value" id="morphFactor-display">1.00</span>
                        </div>
                        <input type="range" id="morphFactor" class="control-slider" min="0" max="2" step="0.01" value="1"
                               oninput="updateParameter('morphFactor', this.value)">
                    </div>
                    <div class="control-group">
                        <div class="control-label">
                            <span>Chaos</span>
                            <span class="control-value" id="chaos-display">0.20</span>
                        </div>
                        <input type="range" id="chaos" class="control-slider" min="0" max="1" step="0.01" value="0.2"
                               oninput="updateParameter('chaos', this.value)">
                    </div>
                    <div class="control-group">
                        <div class="control-label">
                            <span>Speed</span>
                            <span class="control-value" id="speed-display">1.00</span>
                        </div>
                        <input type="range" id="speed" class="control-slider" min="0.1" max="3" step="0.01" value="1"
                               oninput="updateParameter('speed', this.value)">
                    </div>
                </div>
            </div>
        </div>

        <!-- Tab 2: Color Content -->
        <div class="bezel-content" id="color-content">
            <div class="tab-content-grid">
                <div class="control-section">
                    <div class="section-title">Color Parameters</div>
                    <div class="control-group">
                        <div class="control-label">
                            <span>Hue</span>
                            <span class="control-value" id="hue-display">200¬∞</span>
                        </div>
                        <input type="range" id="hue" class="control-slider" min="0" max="360" step="1" value="200"
                               oninput="updateParameter('hue', this.value)">
                    </div>
                    <div class="control-group">
                        <div class="control-label">
                            <span>Saturation</span>
                            <span class="control-value" id="saturation-display">0.80</span>
                        </div>
                        <input type="range" id="saturation" class="control-slider" min="0" max="1" step="0.01" value="0.8"
                               oninput="updateParameter('saturation', this.value)">
                    </div>
                    <div class="control-group">
                        <div class="control-label">
                            <span>Intensity</span>
                            <span class="control-value" id="intensity-display">0.50</span>
                        </div>
                        <input type="range" id="intensity" class="control-slider" min="0" max="1" step="0.01" value="0.5"
                               oninput="updateParameter('intensity', this.value)">
                    </div>
                </div>
            </div>
        </div>

        <!-- Tab 3: Geometry Content (8 Base + 3 Core Tabs = 24 Geometries) -->
        <div class="bezel-content" id="geometry-content">
            <div class="tab-content-grid">
                <div class="control-section">
                    <div class="section-title">üìê 24 Geometry System</div>
                    <div class="geometry-container" data-active-core="base">
                        <!-- Core Type Tabs (3 tabs) -->
                        <div id="coreTabsContainer">
                            <!-- Populated by geometry-tabs.js -->
                        </div>

                        <!-- Base Geometry Buttons (8 buttons) -->
                        <div class="geometry-grid" id="geometryGrid">
                            <!-- Populated by geometry-tabs.js -->
                        </div>
                    </div>

                    <!-- Geometry Info Display -->
                    <div style="margin-top: 15px; padding: 12px; background: rgba(0, 0, 0, 0.3); border: 1px solid rgba(0, 255, 255, 0.15); border-radius: 8px;">
                        <div style="font-family: 'Orbitron', monospace; font-size: 0.75rem; color: rgba(255, 255, 255, 0.7); text-align: center;">
                            <strong style="color: #00ffff;">Active Geometry:</strong>
                            <span data-geometry-display style="color: #ffffff;">Tetrahedron</span>
                            <span style="opacity: 0.6; margin-left: 10px;">(#<span data-geometry-display data-geometry-index="0">0</span>)</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tab 4: Reactivity Content -->
        <div class="bezel-content" id="reactivity-content">
            <div class="tab-content-grid">
                <!-- Interactivity Matrix -->
                <div class="control-section">
                    <div class="section-title">üéõÔ∏è Interactivity Matrix</div>
                    <div class="reactivity-grid">
                        <div class="reactivity-header"></div>
                        <div class="reactivity-header">üî∑ FACET</div>
                        <div class="reactivity-header">üåå QUANTUM</div>
                        <div class="reactivity-header">‚ú® HOLO</div>

                        <div class="reactivity-label">üñ±Ô∏è Mouse</div>
                        <div class="reactivity-cell" onclick="document.getElementById('facetedMouse').click()">
                            <input type="checkbox" id="facetedMouse" onchange="toggleSystemReactivity('faceted', 'mouse', this.checked)">
                            <span class="cell-text">ROT</span>
                        </div>
                        <div class="reactivity-cell" onclick="document.getElementById('quantumMouse').click()">
                            <input type="checkbox" id="quantumMouse" onchange="toggleSystemReactivity('quantum', 'mouse', this.checked)">
                            <span class="cell-text">VEL</span>
                        </div>
                        <div class="reactivity-cell" onclick="document.getElementById('holographicMouse').click()">
                            <input type="checkbox" id="holographicMouse" onchange="toggleSystemReactivity('holographic', 'mouse', this.checked)">
                            <span class="cell-text">SHIMMER</span>
                        </div>

                        <div class="reactivity-label">üëÜ Click</div>
                        <div class="reactivity-cell" onclick="document.getElementById('facetedClick').click()">
                            <input type="checkbox" id="facetedClick" onchange="toggleSystemReactivity('faceted', 'click', this.checked)">
                            <span class="cell-text">BURST</span>
                        </div>
                        <div class="reactivity-cell" onclick="document.getElementById('quantumClick').click()">
                            <input type="checkbox" id="quantumClick" onchange="toggleSystemReactivity('quantum', 'click', this.checked)">
                            <span class="cell-text">BLAST</span>
                        </div>
                        <div class="reactivity-cell" onclick="document.getElementById('holographicClick').click()">
                            <input type="checkbox" id="holographicClick" onchange="toggleSystemReactivity('holographic', 'click', this.checked)">
                            <span class="cell-text">RIPPLE</span>
                        </div>

                        <div class="reactivity-label">üåÄ Scroll</div>
                        <div class="reactivity-cell" onclick="document.getElementById('facetedScroll').click()">
                            <input type="checkbox" id="facetedScroll" onchange="toggleSystemReactivity('faceted', 'scroll', this.checked)">
                            <span class="cell-text">CYCLE</span>
                        </div>
                        <div class="reactivity-cell" onclick="document.getElementById('quantumScroll').click()">
                            <input type="checkbox" id="quantumScroll" onchange="toggleSystemReactivity('quantum', 'scroll', this.checked)">
                            <span class="cell-text">WAVE</span>
                        </div>
                        <div class="reactivity-cell" onclick="document.getElementById('holographicScroll').click()">
                            <input type="checkbox" id="holographicScroll" onchange="toggleSystemReactivity('holographic', 'scroll', this.checked)">
                            <span class="cell-text">SWEEP</span>
                        </div>
                    </div>
                    <div class="reactivity-note">Toggle mouse, click, and scroll interactions per system</div>
                </div>

                <!-- Audio Reactivity Matrix -->
                <div class="control-section">
                    <div class="section-title">üéµ Audio Reactivity Matrix</div>
                    <div class="audio-grid">
                        <div class="audio-header"></div>
                        <div class="audio-header">üé® COLOR</div>
                        <div class="audio-header">üß¨ GEO</div>
                        <div class="audio-header">üåÄ MOVE</div>

                        <div class="audio-label">LOW</div>
                        <div class="audio-cell" onclick="document.getElementById('lowColor').click()">
                            <input type="checkbox" id="lowColor" onchange="toggleAudioReactivity('low', 'color', this.checked)">
                            <span class="cell-text">30%</span>
                        </div>
                        <div class="audio-cell" onclick="document.getElementById('lowGeometry').click()">
                            <input type="checkbox" id="lowGeometry" onchange="toggleAudioReactivity('low', 'geometry', this.checked)">
                            <span class="cell-text">30%</span>
                        </div>
                        <div class="audio-cell" onclick="document.getElementById('lowMovement').click()">
                            <input type="checkbox" id="lowMovement" onchange="toggleAudioReactivity('low', 'movement', this.checked)">
                            <span class="cell-text">30%</span>
                        </div>

                        <div class="audio-label">MED</div>
                        <div class="audio-cell" onclick="document.getElementById('mediumColor').click()">
                            <input type="checkbox" id="mediumColor" checked onchange="toggleAudioReactivity('medium', 'color', this.checked)">
                            <span class="cell-text">100%</span>
                        </div>
                        <div class="audio-cell" onclick="document.getElementById('mediumGeometry').click()">
                            <input type="checkbox" id="mediumGeometry" onchange="toggleAudioReactivity('medium', 'geometry', this.checked)">
                            <span class="cell-text">100%</span>
                        </div>
                        <div class="audio-cell" onclick="document.getElementById('mediumMovement').click()">
                            <input type="checkbox" id="mediumMovement" onchange="toggleAudioReactivity('medium', 'movement', this.checked)">
                            <span class="cell-text">100%</span>
                        </div>

                        <div class="audio-label">HIGH</div>
                        <div class="audio-cell" onclick="document.getElementById('highColor').click()">
                            <input type="checkbox" id="highColor" onchange="toggleAudioReactivity('high', 'color', this.checked)">
                            <span class="cell-text">200%</span>
                        </div>
                        <div class="audio-cell" onclick="document.getElementById('highGeometry').click()">
                            <input type="checkbox" id="highGeometry" onchange="toggleAudioReactivity('high', 'geometry', this.checked)">
                            <span class="cell-text">200%</span>
                        </div>
                        <div class="audio-cell" onclick="document.getElementById('highMovement').click()">
                            <input type="checkbox" id="highMovement" onchange="toggleAudioReactivity('high', 'movement', this.checked)">
                            <span class="cell-text">200%</span>
                        </div>
                    </div>
                    <div class="audio-note">Control audio sensitivity and which parameters react</div>
                </div>
            </div>
        </div>

        <!-- Tab 5: Export Content -->
        <div class="bezel-content" id="export-content">
            <div class="tab-content-grid">
                <div class="control-section">
                    <div class="section-title">üì§ Export & Actions</div>
                    <div class="action-button-row">
                        <button class="panel-btn" onclick="createTradingCard()">üé¥ Trading Card</button>
                        <button class="panel-btn" onclick="openGallery()">üñºÔ∏è Open Gallery</button>
                        <button class="panel-btn" onclick="resetAll()">üîÑ Reset All</button>
                    </div>
                    <div style="margin-top: 15px; padding: 12px; background: rgba(0, 0, 0, 0.3); border: 1px solid rgba(0, 255, 255, 0.15); border-radius: 8px; text-align: center;">
                        <div style="font-family: 'Orbitron', monospace; font-size: 0.75rem; color: rgba(255, 255, 255, 0.7);">
                            üí° <strong style="color: #00ffff;">TIP:</strong> Use <strong>üé≤ Randomize All</strong> and <strong>üéØ Random Tab</strong> buttons at the top of each tab to randomize parameters!
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- URL Parameter Handler (runs first) -->
    <script type="module" src="js/core/url-params.js"></script>

    <!-- Gallery Preview Fix (runs early for gallery previews) -->
    <script type="module" src="js/core/gallery-preview-fix.js"></script>

    <!-- Core JavaScript Modules (NEW CLEAN ARCHITECTURE) - Order matters for globals -->
    <script type="module" src="js/audio/audio-engine.js"></script>
    <script type="module" src="js/controls/ui-handlers.js"></script>
    <script type="module" src="js/gallery/gallery-manager.js"></script>
    <script type="module" src="js/gallery/gallery-modal.js"></script>
    <script type="module" src="js/ui/bezel-tabs.js"></script>
    <script type="module" src="js/geometry/geometry-tabs.js"></script>
    <script type="module" src="js/interactions/device-tilt.js"></script>
    <script type="module" src="js/core/ui-fixes.js"></script>

    <!-- Enhanced UI Modules -->
    <script type="module" src="js/ui/geometric-icons.js"></script>
    <script type="module" src="js/core/comprehensive-fixes.js"></script>
    <script type="module" src="js/core/global-shortcuts.js"></script>
    <script type="module" src="js/core/performance-optimizer.js"></script>
    
    <!-- Initialize globals and user parameter state BEFORE main app -->
    <script>
        // Initialize global state that modules need
        window.userParameterState = {};
        // CRITICAL FIX: Don't overwrite currentSystem if URL parameters already set it
        if (!window.currentSystem) {
            window.currentSystem = 'faceted';
            console.log('üîß Global: Set currentSystem to default faceted');
        } else {
            console.log(`üîß Global: Preserving existing currentSystem = '${window.currentSystem}'`);
        }
        window.moduleReady = false;
        
        // Initialize geometries data - 24 GEOMETRIES PER SYSTEM
        window.geometries = {
            faceted: [
                // Base geometries (0-7)
                'Tetrahedron', 'Hypercube', 'Sphere', 'Torus', 'Klein Bottle', 'Fractal', 'Wave', 'Crystal',
                // Hypersphere Core (8-15)
                'üåÄ Tetrahedron Core', 'üåÄ Hypercube Core', 'üåÄ Sphere Core', 'üåÄ Torus Core',
                'üåÄ Klein Core', 'üåÄ Fractal Core', 'üåÄ Wave Core', 'üåÄ Crystal Core',
                // Hypertetrahedron Core (16-23)
                'üî∫ Tetrahedron Core', 'üî∫ Hypercube Core', 'üî∫ Sphere Core', 'üî∫ Torus Core',
                'üî∫ Klein Core', 'üî∫ Fractal Core', 'üî∫ Wave Core', 'üî∫ Crystal Core'
            ],
            quantum: [
                // Base geometries (0-7)
                'Tetrahedron', 'Hypercube', 'Sphere', 'Torus', 'Klein Bottle', 'Fractal', 'Wave', 'Crystal',
                // Hypersphere Core (8-15)
                'üåÄ Tetrahedron Core', 'üåÄ Hypercube Core', 'üåÄ Sphere Core', 'üåÄ Torus Core',
                'üåÄ Klein Core', 'üåÄ Fractal Core', 'üåÄ Wave Core', 'üåÄ Crystal Core',
                // Hypertetrahedron Core (16-23)
                'üî∫ Tetrahedron Core', 'üî∫ Hypercube Core', 'üî∫ Sphere Core', 'üî∫ Torus Core',
                'üî∫ Klein Core', 'üî∫ Fractal Core', 'üî∫ Wave Core', 'üî∫ Crystal Core'
            ],
            holographic: ['HOLOGRAPHIC'], // Single holographic mode
            polychora: ['5-CELL', 'TESSERACT', '16-CELL', '24-CELL', '600-CELL', '120-CELL']
        };
        
        console.log('üîß Global state initialized for clean architecture');
    </script>

    <!-- Main Application Module -->
    <script type="module">
        (async function() {
            try {
                console.log('üì¶ Starting system imports...');
                
                // Import the main app first
                const VIB34DApp = (await import('./js/core/app.js')).default;
                console.log('‚úÖ VIB34DApp imported');
                
                // Try to import system engines - make them optional for clean architecture demo
                let VIB34DIntegratedEngine, QuantumEngine, RealHolographicSystem, PolychoraSystem;
                let CollectionManager, UnifiedSaveManager, ParameterMapper, CanvasManager, TradingCardGenerator, ReactivityManager;
                
                try {
                    const coreEngine = await import('./src/core/Engine.js');
                    VIB34DIntegratedEngine = coreEngine.VIB34DIntegratedEngine;
                    console.log('‚úÖ VIB34DIntegratedEngine imported');
                } catch (e) {
                    console.warn('‚ö†Ô∏è VIB34DIntegratedEngine not available:', e.message);
                }
                
                try {
                    const quantumEngine = await import('./src/quantum/QuantumEngine.js');
                    QuantumEngine = quantumEngine.QuantumEngine;
                    console.log('‚úÖ QuantumEngine imported');
                } catch (e) {
                    console.warn('‚ö†Ô∏è QuantumEngine not available:', e.message);
                }
                
                try {
                    const holoSystem = await import('./src/holograms/RealHolographicSystem.js');
                    RealHolographicSystem = holoSystem.RealHolographicSystem;
                    console.log('‚úÖ RealHolographicSystem imported');
                } catch (e) {
                    console.warn('‚ö†Ô∏è RealHolographicSystem not available:', e.message);
                }
                
                try {
                    const newPolySystem = await import('./src/core/PolychoraSystemNew.js');
                    NewPolychoraEngine = newPolySystem.NewPolychoraEngine;
                    console.log('‚úÖ NEW 4D Polychora Engine imported with VIB34D DNA');
                } catch (e) {
                    console.warn('‚ö†Ô∏è New Polychora Engine not available:', e.message);
                    // Fallback to old system if new one fails
                    try {
                        const polySystem = await import('./src/core/PolychoraSystem.js');
                        NewPolychoraEngine = polySystem.PolychoraSystem;
                        console.log('‚úÖ Fallback to old PolychoraSystem');
                    } catch (e2) {
                        console.warn('‚ö†Ô∏è No Polychora system available:', e2.message);
                    }
                }
                
                // Import other components with fallbacks
                try {
                    const canvasManager = await import('./src/core/CanvasManager.js');
                    CanvasManager = canvasManager.CanvasManager;
                } catch (e) {
                    console.warn('‚ö†Ô∏è CanvasManager not available - using stub');
                }
                
                try {
                    const unifiedReactivityManager = await import('./src/core/UnifiedReactivityManager.js');
                    UnifiedReactivityManager = unifiedReactivityManager.UnifiedReactivityManager;
                    console.log('‚úÖ UnifiedReactivityManager imported');
                } catch (e) {
                    console.warn('‚ö†Ô∏è UnifiedReactivityManager not available');
                }
                
                try {
                    const reactivityManager = await import('./src/core/ReactivityManager.js');
                    ReactivityManager = reactivityManager.ReactivityManager;
                } catch (e) {
                    console.warn('‚ö†Ô∏è ReactivityManager not available - using stub');
                }

                // Store engine classes globally for system switching
                window.engineClasses = {
                    VIB34DIntegratedEngine,
                    QuantumEngine,
                    RealHolographicSystem,
                    NewPolychoraEngine
                };
                
                console.log('üì¶ Engine classes stored:', Object.keys(window.engineClasses).filter(k => window.engineClasses[k]));

                // Initialize Unified Reactivity Manager FIRST
                if (UnifiedReactivityManager) {
                    const reactivityManager = new UnifiedReactivityManager();
                    console.log('‚úÖ UnifiedReactivityManager initialized');
                } else {
                    // Fallback getCurrentReactivityState function
                    window.getCurrentReactivityState = function() {
                        return {
                            system: window.currentSystem || 'faceted',
                            mouse: { faceted: true, quantum: false, holographic: false, polychora: false, mixed: false },
                            click: { faceted: true, quantum: false, holographic: false, polychora: false, mixed: false },
                            scroll: { faceted: true, quantum: false, holographic: false, polychora: false, mixed: false },
                            audio: window.audioEnabled || false,
                            interactivity: window.interactivityEnabled !== false,
                            deviceTilt: window.deviceTiltHandler?.isEnabled || false
                        };
                    };
                    console.log('‚ö†Ô∏è Using fallback getCurrentReactivityState');
                }

                // Initialize VIB34D Application
                const app = new VIB34DApp();
                window.vib34dApp = app;
                
                // CRITICAL FIX: Ensure global functions are available IMMEDIATELY for gallery previews
                await app.initialize();
                
                // Force check that essential functions are global
                if (!window.syncVisualizerToUI) {
                    console.error('üö® CRITICAL: syncVisualizerToUI not available globally after app init');
                } else {
                    console.log('‚úÖ Essential functions available globally');
                }

                // Initialize default system
                const initialSystem = window.currentSystem || 'faceted';
                if (window.switchSystem) {
                    await window.switchSystem(initialSystem);
                }
                
                if (window.setupGeometry) {
                    window.setupGeometry(initialSystem);
                }

                window.moduleReady = true;
                document.body.classList.remove('loading');

                console.log('üöÄ VIB34D Clean Architecture System Loaded');
                
                // TESTING MODE: Run architecture tests if requested
                const urlParams = new URLSearchParams(window.location.search);
                if (urlParams.has('testing-mode')) {
                    console.log('üß™ TESTING MODE: Running architecture validation...');
                    
                    // Add test results overlay
                    const testOverlay = document.createElement('div');
                    testOverlay.id = 'test-overlay';
                    testOverlay.style.cssText = `
                        position: fixed;
                        top: 60px;
                        left: 20px;
                        width: 400px;
                        max-height: 80vh;
                        overflow-y: auto;
                        background: rgba(0, 0, 0, 0.95);
                        border: 2px solid #00ffff;
                        border-radius: 10px;
                        padding: 15px;
                        font-family: 'Orbitron', monospace;
                        font-size: 0.8rem;
                        color: #fff;
                        z-index: 9999;
                    `;
                    testOverlay.innerHTML = `
                        <h3 style="color: #00ffff; margin-bottom: 10px;">üß™ ARCHITECTURE TEST</h3>
                        <div id="test-results"></div>
                    `;
                    document.body.appendChild(testOverlay);
                    
                    // Run tests  
                    setTimeout(runArchitectureTests, 1000);
                    
                    function runArchitectureTests() {
                    const results = document.getElementById('test-results');
                    let passedTests = 0;
                    let totalTests = 0;
                    
                    function logTest(message, passed) {
                        totalTests++;
                        if (passed) passedTests++;
                        
                        const div = document.createElement('div');
                        div.style.cssText = `color: ${passed ? '#00ff00' : '#ff4444'}; margin: 2px 0;`;
                        div.innerHTML = `${passed ? '‚úÖ' : '‚ùå'} ${message}`;
                        results.appendChild(div);
                    }
                    
                    // Test essential functions
                    logTest('window.switchSystem available', typeof window.switchSystem === 'function');
                    logTest('window.selectGeometry available', typeof window.selectGeometry === 'function');
                    logTest('window.updateParameter available', typeof window.updateParameter === 'function');
                    logTest('window.randomizeAll available', typeof window.randomizeAll === 'function');
                    logTest('window.resetAll available', typeof window.resetAll === 'function');
                    
                    // Test DOM elements
                    logTest('Canvas Container exists', !!document.getElementById('canvasContainer'));
                    logTest('Control Panel exists', !!document.getElementById('controlPanel'));
                    logTest('Panel Header exists', !!document.getElementById('panelHeader'));
                    logTest('Faceted Layers exist', !!document.getElementById('vib34dLayers'));
                    
                    // Test parameter controls
                    const params = ['rot4dXW', 'rot4dYW', 'rot4dZW', 'gridDensity', 'morphFactor', 'chaos', 'speed', 'hue', 'intensity', 'saturation'];
                    params.forEach(param => {
                        const slider = document.getElementById(param);
                        logTest(`${param} slider exists`, !!slider);
                    });
                    
                    // Test system buttons
                    const systems = ['faceted', 'quantum', 'holographic', 'polychora'];
                    systems.forEach(system => {
                        const btn = document.querySelector(`[data-system="${system}"]`);
                        logTest(`${system} button exists`, !!btn);
                    });
                    
                    // Final results
                    const passRate = ((passedTests / totalTests) * 100).toFixed(1);
                    const finalDiv = document.createElement('div');
                    finalDiv.style.cssText = `
                        color: ${passRate >= 90 ? '#00ff00' : passRate >= 70 ? '#ffff00' : '#ff4444'};
                        font-weight: bold;
                        margin-top: 10px;
                        padding: 10px;
                        border-top: 1px solid #333;
                    `;
                    finalDiv.innerHTML = `
                        <div>üìä RESULT: ${passedTests}/${totalTests} (${passRate}%)</div>
                        <div>${passRate >= 90 ? '‚úÖ ARCHITECTURE READY' : passRate >= 70 ? '‚ö†Ô∏è NEEDS FIXES' : '‚ùå CRITICAL ISSUES'}</div>
                    `;
                    results.appendChild(finalDiv);
                    
                    console.log(`üß™ Architecture test complete: ${passedTests}/${totalTests} passed (${passRate}%)`);
                    }
                }
                
            } catch (error) {
                console.error('‚ùå Failed to initialize VIB34D system:', error);
                document.body.classList.remove('loading');
                
                // Show error overlay
                const errorDiv = document.createElement('div');
                errorDiv.style.cssText = `
                    position: fixed;
                    top: 50%;
                    left: 50%;
                    transform: translate(-50%, -50%);
                    background: rgba(255, 0, 0, 0.9);
                    color: white;
                    padding: 20px;
                    border-radius: 10px;
                    font-family: 'Orbitron', monospace;
                    z-index: 10000;
                    max-width: 80vw;
                `;
                errorDiv.innerHTML = `
                    <h3>‚ùå VIB34D Initialization Failed</h3>
                    <p>${error.message}</p>
                    <small>Check console for details</small>
                `;
                document.body.appendChild(errorDiv);
            }
        })();
    </script>
</body>
</html>